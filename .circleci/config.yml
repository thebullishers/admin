version: 2.1

###################
#  EXECUTORS
###################

executors:
  node:
    docker:
      - image: cimg/node:16.13

###################
#  COMMANDS
###################

commands:
  install_node_version:
    description: Install Node version with NVM
    steps:
      - run:
          name: Install Node version with NVM
          command: |
            set +e
            curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.39.1/install.sh | bash
            echo 'export NVM_DIR="$HOME/.nvm"' >> $BASH_ENV
            echo '[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"' >> $BASH_ENV
            source $BASH_ENV
            nvm install --default
            nvm use

  install_node_modules:
    description: Install Node Dependencies
    steps:
      - restore_cache:
          name: Restore Node Modules
          keys:
            - node-modules-v1-{{ checksum "yarn.lock" }}-{{ arch }}
      - run:
          name: Install Dependencies
          command: yarn install --immutable
      - save_cache:
          name: Save Node Modules
          key: node-modules-v1-{{ checksum "yarn.lock" }}-{{ arch }}
          paths:
            - node_modules

  build:
    description: Build
    parameters:
      env:
        type: string
    steps:
      - install_node_version
      - install_node_modules
      - run: |
          yarn build


###################
#  JOBS
###################

jobs:
  checkout-and-install-deps:
    executor: node
    working_directory: ~/thebullishers
    steps:
      - checkout
      - install_node_modules

  test:
    executor: node
    working_directory: ~/thebullishers
    steps:
      - checkout
      - install_node_modules
      - run:
          name: Unit Tests
          command: yarn test



###################
#  WORKFLOWS
###################

workflows:
  version: 2.1
  commit:
    jobs:
      - checkout-and-install-deps:
          filters:
            tags:
              only: /.*/
      - test:
          requires:
            - checkout-and-install-deps
